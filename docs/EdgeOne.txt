Webhook ç«¯ç‚¹é…ç½®è¯¦è§£
ä»€ä¹ˆæ˜¯ç«¯ç‚¹
ç«¯ç‚¹æ˜¯æ‚¨æœåŠ¡å™¨ä¸Šçš„ä¸€ä¸ª URLï¼Œç”¨äºæ¥æ”¶æ¥è‡ª Pages çš„ Webhook è¯·æ±‚ã€‚
è¯·æ±‚æ ¼å¼
å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒPages ä¼šå‘æ‚¨çš„ç«¯ç‚¹å‘é€ HTTP POST è¯·æ±‚ã€‚
HTTP è¯·æ±‚å¤´ï¼š
POST /webhooks/edgeone-pages HTTP/1.1
Host: example.com
Content-Type: application/json
Accept: application/json, text/plain, */*
Accept-Encoding: gzip, compress, deflate, br
Authorization: Bearer xxx
Connection: keep-alive
è¯·æ±‚ä½“ç¤ºä¾‹ï¼ˆJSON æ ¼å¼ï¼‰ï¼š
éƒ¨ç½²äº‹ä»¶ç¤ºä¾‹ï¼ˆdeployment.createdï¼‰ï¼š
{
  "eventType": "deployment.created",
  "appId": "app-123",
  "projectId": "project-456",
  "deploymentId": "deploy-789",
  "projectName": "my-project",
  "repoBranch": "main",
  "timestamp": "2024-01-13T12:34:56.789Z"
}
é¡¹ç›®äº‹ä»¶ç¤ºä¾‹ï¼ˆproject.createdï¼‰ï¼š
{
  "eventType": "project.created",
  "appId": "app-123",
  "projectId": "project-456",
  "projectName": "my-project",
  "repoUrl": "https://github.com/user/repo",
  "timestamp": "2024-01-13T12:34:56.789Z"
}
åŸŸåäº‹ä»¶ç¤ºä¾‹ï¼ˆdomain.addedï¼‰ï¼š
{
  "eventType": "domain.added",
  "appId": "app-123",
  "projectId": "project-456",
  "projectName": "my-project",
  "domainName": "example.com",
  "domainId": "domain-789",
  "timestamp": "2024-01-13T12:34:56.789Z"
}
å­—æ®µè¯´æ˜ï¼š
å­—æ®µ
ç±»å‹
è¯´æ˜
å‡ºç°åœºæ™¯
eventType
string
äº‹ä»¶ç±»å‹
æ‰€æœ‰äº‹ä»¶
appId
string
è´¦æˆ· ID
æ‰€æœ‰äº‹ä»¶
projectId
string
é¡¹ç›® ID
æ‰€æœ‰äº‹ä»¶
timestamp
string
äº‹ä»¶å‘ç”Ÿçš„æ—¶é—´æˆ³ï¼ˆISO 8601 æ ¼å¼ï¼‰
æ‰€æœ‰äº‹ä»¶
projectName
string
é¡¹ç›®åç§°
æ‰€æœ‰äº‹ä»¶
deploymentId
string
éƒ¨ç½² ID
éƒ¨ç½²äº‹ä»¶
repoBranch
string
Git åˆ†æ”¯
éƒ¨ç½²äº‹ä»¶
repoUrl
string
ä»“åº“ URL
é¡¹ç›®äº‹ä»¶
domainName
string
åŸŸå
åŸŸåäº‹ä»¶
domainId
string
åŸŸå ID
åŸŸåäº‹ä»¶
æ³¨æ„ï¼š
å¦‚æœæ‚¨çš„ç«¯ç‚¹è¿”å›é 2xx çŠ¶æ€ç æˆ–æ— æ³•è®¿é—®ï¼ŒPages ä¼šé‡‡å–æŒ‡æ•°é€€é¿ç­–ç•¥è‡ªåŠ¨é‡è¯•æœ€å¤š 3 æ¬¡ã€‚
å¦‚ä½•å®ç°ç«¯ç‚¹
æ‚¨éœ€è¦åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šå®ç°ä¸€ä¸ªç«¯ç‚¹æ¥æ¥æ”¶ Webhook è¯·æ±‚ã€‚ä»¥ä¸‹æ˜¯ä¸€ä¸ª Cloud Functions çš„ç¤ºä¾‹ï¼š
/**
 * API è·¯å¾„: /webhooks/demo
 */
ï»¿
/**
 * éªŒè¯ Bearer Tokenï¼ˆå¯é€‰ï¼‰
 */
function verifyToken(authHeader, expectedToken) {
  if (!expectedToken) return true; // æœªé…ç½®åˆ™è·³è¿‡éªŒè¯
  
  const parts = authHeader?.split(' ');
  if (parts?.length !== 2 || parts[0] !== 'Bearer') return false;
  
  return parts[1] === expectedToken;
}
ï»¿
/**
 * å¤„ç† webhook äº‹ä»¶
 */
function handleEvent(eventType, data) {
  switch (eventType) {
    case 'deployment.created':
      console.log(`ğŸš€ éƒ¨ç½²åˆ›å»º: ${data.projectName} (${data.repoBranch})`);
      // åœ¨æ­¤æ·»åŠ ä½ çš„ä¸šåŠ¡é€»è¾‘
      // ä¾‹å¦‚: å‘é€é€šçŸ¥ã€æ›´æ–°æ•°æ®åº“ç­‰
      return { message: 'éƒ¨ç½²äº‹ä»¶å·²å¤„ç†', projectName: data.projectName };
      
    case 'project.created':
      console.log(`ğŸ“ é¡¹ç›®åˆ›å»º: ${data.projectName}`);
      return { message: 'é¡¹ç›®äº‹ä»¶å·²å¤„ç†', projectName: data.projectName };
    // æ›´å¤šäº‹ä»¶å¯å‚è€ƒæ”¯æŒçš„äº‹ä»¶ç±»å‹
    default:
      console.log(`âš ï¸ æœªçŸ¥äº‹ä»¶: ${eventType}`);
      return { message: 'æœªçŸ¥äº‹ä»¶ç±»å‹', eventType };
  }
}
ï»¿
/**
 * Cloud Function å…¥å£
 */
export async function onRequest(context) {
  const { request, env } = context;
ï»¿
  // 1. å¥åº·æ£€æŸ¥
  if (request.method === 'GET') {
    return new Response(JSON.stringify({ status: 'ok', message: 'Webhook endpoint is ready' }), {
      headers: { 'Content-Type': 'application/json' }
    });
  }
ï»¿
  // 2. åªæ¥å— POST
  if (request.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), {
      status: 405,
      headers: { 'Content-Type': 'application/json' }
    });
  }
ï»¿
  try {
    // 3. éªŒè¯ Bearer Tokenï¼ˆå¯é€‰ï¼‰
    const authHeader = request.headers.get('authorization');
    const webhookToken = env.WEBHOOK_TOKEN;
    
    if (webhookToken && !verifyToken(authHeader, webhookToken)) {
      return new Response(JSON.stringify({ error: 'Unauthorized' }), {
        status: 401,
        headers: { 'Content-Type': 'application/json' }
      });
    }
ï»¿
    // 4. è§£æè¯·æ±‚ä½“
    const payload = await request.json();
    const eventType = payload.eventType || payload.type;
ï»¿
    // 5. å¤„ç†äº‹ä»¶
    const result = handleEvent(eventType, payload);
ï»¿
    // 6. è¿”å›æˆåŠŸå“åº”
    return new Response(JSON.stringify({
      success: true,
      eventType,
      result,
      timestamp: new Date().toISOString()
    }), {
      status: 200,
      headers: { 'Content-Type': 'application/json' }
    });
ï»¿
  } catch (error) {
    console.error('å¤„ç†é”™è¯¯:', error);
    return new Response(JSON.stringify({
      error: 'Internal server error',
      message: error.message
    }), {
      status: 500,
      headers: { 'Content-Type': 'application/json' }
    });
  }
}